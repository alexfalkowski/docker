version: 2.1

parameters:
  root:
    type: boolean
    default: false
  docker:
    type: boolean
    default: false

jobs:
  lint:
    docker:
      - image: alexfalkowski/docker:1.21
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - run: make scripts-lint
    resource_class: large
  release:
    docker:
      - image: alexfalkowski/release:3.24
    working_directory: ~/docker
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - run: make pull
      - run: release
    resource_class: large

  docker-lint:
    docker:
      - image: alexfalkowski/docker:1.21
    working_directory: ~/docker
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - run: make -C docker lint-docker
    resource_class: large
  docker-build-amd64:
    docker:
      - image: alexfalkowski/docker:1.21
    working_directory: ~/docker
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: make login
          command: echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      - run: make -C docker platform=amd64 build-docker
    resource_class: large
  docker-push-amd64:
    docker:
      - image: alexfalkowski/docker:1.21
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: make login
          command: echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      - run: make -C docker platform=amd64 push-docker
    resource_class: large
  docker-build-arm64:
    docker:
      - image: alexfalkowski/docker:1.21
    working_directory: ~/docker
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: make login
          command: echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      - run: make -C docker platform=arm64 build-docker
    resource_class: arm.medium
  docker-push-arm64:
    docker:
      - image: alexfalkowski/docker:1.21
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: make login
          command: echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      - run: make -C docker platform=arm64 push-docker
    resource_class: arm.medium
  docker-manifest:
    docker:
      - image: alexfalkowski/docker:1.21
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: make login
          command: echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      - run: make -C docker manifest-docker
    resource_class: large

  root-lint:
    docker:
      - image: alexfalkowski/docker:1.21
    working_directory: ~/docker
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - run: make -C root lint-docker
    resource_class: large
  root-build-amd64:
    docker:
      - image: alexfalkowski/docker:1.21
    working_directory: ~/docker
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: make login
          command: echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      - run: make -C root platform=amd64 build-docker
    resource_class: large
  root-push-amd64:
    docker:
      - image: alexfalkowski/docker:1.21
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: make login
          command: echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      - run: make -C root platform=amd64 push-docker
    resource_class: large
  root-build-arm64:
    docker:
      - image: alexfalkowski/docker:1.21
    working_directory: ~/docker
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: make login
          command: echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      - run: make -C root platform=arm64 build-docker
    resource_class: arm.medium
  root-push-arm64:
    docker:
      - image: alexfalkowski/docker:1.21
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: make login
          command: echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      - run: make -C root platform=arm64 push-docker
    resource_class: arm.medium
  root-manifest:
    docker:
      - image: alexfalkowski/docker:1.21
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: make login
          command: echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      - run: make -C root manifest-docker
    resource_class: large

workflows:
  lint:
    jobs:
      - lint
      - release:
          requires:
            - lint
          filters:
            branches:
              only: master

  docker:
    when: << pipeline.parameters.docker >>
    jobs:
      - docker-lint
      - docker-build-amd64:
          context: docker
          filters:
            branches:
              ignore: master
      - docker-build-arm64:
          context: docker
          filters:
            branches:
              ignore: master
      - docker-push-amd64:
          context: docker
          filters:
            branches:
              only: master
      - docker-push-arm64:
          context: docker
          filters:
            branches:
              only: master
      - docker-manifest:
          context: docker
          requires:
            - docker-push-amd64
            - docker-push-arm64
          filters:
            branches:
              only: master

  root:
    when: << pipeline.parameters.root >>
    jobs:
      - root-lint
      - root-build-amd64:
          context: docker
          filters:
            branches:
              ignore: master
      - root-build-arm64:
          context: docker
          filters:
            branches:
              ignore: master
      - root-push-amd64:
          context: docker
          filters:
            branches:
              only: master
      - root-push-arm64:
          context: docker
          filters:
            branches:
              only: master
      - root-manifest:
          context: docker
          requires:
            - root-push-amd64
            - root-push-arm64
          filters:
            branches:
              only: master
