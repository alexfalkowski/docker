# AGENTS.md

This repository is a collection of Docker images plus a `compose.yml` for local dependencies. It is primarily driven by `make` targets and linted via `shellcheck` and `hadolint`.

## Quick start

### Get submodules (required)

The top-level `Makefile` includes make fragments from the `bin/` submodule (`include bin/build/make/...`). If `bin/` is not present, most `make` targets will fail.

```sh
git submodule sync
git submodule update --init
```

(Equivalent make target is provided by `bin/build/make/git.mak`: `make submodule`.)

### Show available make targets

```sh
make
# or
make help
```

Help output is generated by `bin/build/make/help.mak`.

## Repository layout

- `docker/`, `go/`, `k8s/`, `monitoror/`, `release/`, `root/`, `ruby/`
  - Each directory builds a Docker image.
  - Each has a `Makefile` that sets `IMAGE` and `VERSION` and includes `../make/docker.mk`.
  - Each typically has:
    - `Dockerfile`
    - `.hadolint.yaml` (directory-specific hadolint rule suppressions)
- `make/docker.mk`: shared make targets for building/pushing/linting images.
- `scripts/`
  - `scripts/compose`: wrapper that uses `podman compose` if available, otherwise `docker compose`.
  - `scripts/clean`: prunes unused images via `podman image prune -a -f` or `docker image prune -a -f`.
- `compose.yml`: local dependency stack (postgres/redis/localstack/vault + observability stack).
- `.circleci/`
  - `config.yml`: setup config using `circleci/path-filtering` to select which image pipeline to run.
  - `continue_config.yml`: the actual build/lint/push workflows for each image.
- `bin/` (git submodule): shared tooling and make include fragments.

## Essential commands

### Lint scripts

Top-level `Makefile` defines:

```sh
make scripts-lint
```

This runs `shellcheck` against:
- `scripts/clean`, `scripts/compose`
- `release/deploy`, `release/package`, `release/version`

See `Makefile:5-6`.

### Compose (local dependencies)

Top-level `Makefile` targets:

```sh
make docker-pull [service=name]  # pull
make start      [service=name]   # up -d
make stop                      # down
make logs       service=name     # follow logs
```

These invoke `scripts/compose -f compose.yml ...` (docker/podman compose wrapper). See `Makefile:9-22` and `scripts/compose`.

### Clean local docker images

```sh
make clean
```

Runs `scripts/clean` which prunes all images (`docker image prune -a -f` / `podman image prune -a -f`). See `Makefile:24-26` and `scripts/clean`.

## Building & linting Docker images

Image directories share the same targets from `make/docker.mk`:

### Lint a Dockerfile

```sh
make -C <dir> lint-docker
```

`lint-docker` runs `hadolint Dockerfile` (see `make/docker.mk:28-30`).

### Build locally

```sh
make -C <dir> build-docker
```

Builds `alexfalkowski/<IMAGE>:<VERSION>` using `docker build -t ... .` (see `make/docker.mk:1-3`).

### Build/push platform-tagged images

```sh
make -C <dir> platform=amd64 build-platform-docker
make -C <dir> platform=arm64 build-platform-docker

make -C <dir> platform=amd64 push-platform-docker
make -C <dir> platform=arm64 push-platform-docker
```

These targets tag as `<VERSION>.<platform>` and use `docker build ... --push` for push (see `make/docker.mk:9-16`).

### Create multi-arch manifests

```sh
make -C <dir> manifest-platform-docker
```

This creates and pushes two manifests:
- `alexfalkowski/<IMAGE>:<VERSION>`
- `alexfalkowski/<IMAGE>:latest` (no tag)

See `make/docker.mk:17-26`.

## CI (CircleCI)

CI is organized around per-image workflows in `.circleci/continue_config.yml`.

### Path-filtering setup

`.circleci/config.yml` is a setup config (`setup: true`) using `circleci/path-filtering@2.0.4`. It maps changes under directories like `docker/.*`, `go/.*`, etc. into pipeline parameters (see `.circleci/config.yml:8-47`).

### Jobs run per image

For each image directory, CircleCI runs a combination of:
- `*-lint`: `make -C <dir> lint-docker`
- build jobs:
  - some images build `build-docker` (e.g. `monitoror`)
  - others build per-platform with `platform=amd64|arm64 build-platform-docker`
- push jobs on `master` only (DockerHub login via `DOCKERHUB_USERNAME`/`DOCKERHUB_PASS`)
- manifest jobs on `master` only

See `.circleci/continue_config.yml` for the exact job graph and branch filters.

## Conventions & patterns

### Indentation / formatting

`.editorconfig` specifies:
- Default: 2-space indentation, LF line endings, trim trailing whitespace.
- `Makefile`/`*.mk`: tab indentation.

See `.editorconfig`.

### Image naming & versioning

Each image folder has a `Makefile` like:

```make
IMAGE:=<name>
VERSION:=<number>

include ../make/docker.mk
```

Examples:
- `docker/Makefile` sets `IMAGE:=docker` and `VERSION:=1.49`.
- `go/Makefile` sets `IMAGE:=go` and `VERSION:=2.104`.

### Hadolint configuration

There is no single top-level `.hadolint.yaml`; instead, each image directory has its own `.hadolint.yaml` with ignored rules (e.g. `DL4006`, `SC2086`, etc.).

If you add/adjust hadolint suppressions, update the `.hadolint.yaml` in the specific image directory.

## Release tooling

The `release/` image is a purpose-built release container. Its `Dockerfile` installs:
- `gh`, `goreleaser`, `uplift`
- plus a `bump` tool (Go install)

It also includes executable scripts:
- `release/deploy`: runs `uplift release --config-dir /etc/uplift` after `make pull`.
- `release/package`: runs `goreleaser release` when a `*goreleaser*` file exists and the latest commit subject matches `^chore*`.
- `release/version`: runs `make pull` and then raises an infraops PR under certain conditions.

`release/.uplift.yml` defines the release commit message format (`chore(release): $VERSION [ci skip]`) and changelog exclusion for `^chore`.

## Gotchas

- **Submodule required**: `bin/` is a git submodule (`.gitmodules`) and is included by the top-level `Makefile`. Ensure `git submodule update --init` is run before invoking `make`.
- **Submodule URL uses SSH**: `.gitmodules` points at `git@github.com:alexfalkowski/bin.git`, which requires SSH access.
- **Pushing images needs credentials**: CI logs into DockerHub via `DOCKERHUB_USERNAME`/`DOCKERHUB_PASS` before push/manifest steps (`.circleci/continue_config.yml`).
- **Compose wrapper picks podman first**: `scripts/compose` prefers `podman compose` when available; this can affect behavior vs Docker.
- **`make clean` is destructive**: prunes *all* unused images (`docker image prune -a -f`).